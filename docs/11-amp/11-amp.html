<h2 id="lab-11-accelerated-mobile-pages-amp-">Lab 11: Accelerated Mobile Pages (AMP)</h2>
<ol>
<li><p><em>AMP</em> is a way to ensure that web pages render fast on mobile devices, for a better user experience (UX). Visit and browse <a href='https://www.ampproject.org/learn/overview/' target='_blank'>https://www.ampproject.org/learn/overview/</a> to learn more about AMP. Other than fast rendering, one advantage of AMP pages is that Google will cache AMP pages for you for free. There are some restrictions as to what a valid AMP page can include (such as no custom JavaScript), but it allows you to use the full power of CSS. We use the &#39;dynamic&#39;, server-side features of Node.js to help with serving AMP pages where appropriate. It is, however, possible to create a completely static site that serves AMP. In this tutorial, we show how both AMP and non-AMP versions can share common resources to limit content duplication.</p>
</li>
<li><p>In VS Code, reopen the <code>&#39;topseed&#39;</code> project you installed in Lab 5. Then select menu &#39;View-Integrated Terminal&#39;. Ensure you are in directory <code>/demo-topseed-io</code> and type <code>&#39;node index [Enter]&#39;</code>.</p>
</li>
<li><p>In a browser, go to <a href='http://localhost:8092' target='_blank'>http://localhost:8092</a> and see /page/one/ come up. Rightclick on the page to &#39;Show HTML source&#39;. You will note that the <code>head</code> tag has AMP-specific content. To compare, review the HTML source or the non-AMP version at <code>localhost:8091</code>.
In production, we would likely map port 8091 to <code>www.mydomain.com</code> and port 8092 to <code>m.mydomain.com</code>. Behind the scenes, we have a Node module at <code>/server/util/Decider.js</code>. The function of <code>Decider</code> with regard to AMP is twofold: (a) if a request of <code>/page/one/</code> is on the first port, it will return the HTML from <code>/page/one/index.html</code>; if the request is on the second port, it will return the HTML from <code>/page/one/indexA.html</code>. (b) it will attempt to return the alternate version if the requested one does not exist, no matter what port the request arrived on. You can change port numbers in <code>/config/ServerConfig.js</code> (restart with &#39;node index&#39;).</p>
</li>
<li><p>Let us inspect how AMP pages are composed differently, but share some resources. Inspect <code>/page/one/indexA.pug</code>. Our convention is to post-fix AMP-specific resources with a capital <code>&#39;A&#39;</code>. See how <code>/indexA.pug</code> uses <code>_baseShellA.pug</code> and <code>_headerA.pug</code>, but uses the same <code>_footer.pug</code> as non-AMP <code>/index.pug</code>.
Likewise, both <code>/index.pug</code> and <code>/indexA.pug</code> share the use of <code>_hello.html</code>.
<code>indexA.pug</code> also has a required &#39;canonical&#39; link that points to the non-AMP version of the resource. Also note that <code>/indexA.pug</code> does not have the <code>&#39;script&#39;</code> element, since AMP does not permit custom JavaScript. AMP has some custom tags/components to help building AMP pages; see <a href='https://www.ampproject.org/docs/reference/components' target='_blank'>https://www.ampproject.org/docs/reference/components</a>. For example, JavaScript <em>is</em> allowed inside an <code>amp-iframe</code> (example at <a href='https://m.appthings.io' target='_blank'>https://m.appthings.io</a>). </p>
</li>
<li><p>Inspect <code>/_part/_baseShellA.pug</code>. It <em>includes</em> <code>&#39;_topA.pug&#39;</code>, which is a non-JavaScript version of <code>&#39;_top.pug&#39;</code> that uses the <code>&#39;#sidedrawer</code>&#39; anchor combined with CSS to obtain the slide-out functionality without JavaScript. Also inspect <code>/_part/_headerA.pug</code>. It includes <code>&#39;../_sass/mainA.css&#39;</code> inside a <code>&#39;style(amp-custom=&#39;&#39;)&#39;</code> tag. This means that the CSS for AMP is served inline rather than from a separate request. <code>mainA.sass</code> has the same content as <code>main.sass</code>, but having a separate file for <code>mainA</code> allows us to compress or <em>mininize</em> it (we use Prepros on the individual file) for inline use, since AMP files have a total size limitation.</p>
</li>
<li><p>Both AMP and non-AMP versions have the same responsive design features: they adapt to screen size. The AMP version should just be served faster, as optimized and privileged by Google caching. This may be especially important for the home page, where you do not want to let the user wait unnecessarily for the page to render. For custom behavior, you can force the <em>non</em>-AMP version by using the whole path <code>/page/one/index.html</code> in links or in the browser. We could make all <code>&#39;a href&#39;</code> links in the app to go to non-AMP versions by adding <code>/index.html</code> to them. We usually do this to take advantage of the (JavaScript-based) Topseed Turbo feature that provides for a smoother single-page application feel.</p>
</li>
<li><p>In summary, the app supports fast AMP responses but provides for non-AMP fallback versions where necessary. For example, a &#39;Contact Us&#39; page that uses JavaScript to validate submissions would not have an AMP version. <code>Decider.js</code> on the server-side helps to automatically serve the available version.</p>
</li>
<li><p>You can use an AMP validator to ensure your AMP is valid; see <a href='https://validator.ampproject.org' target='_blank'>https://validator.ampproject.org</a>. Your markup has to be valid to be indexed and cached by Google. If your page is online, you can re-validate and submit it at <a href='https://search.google.com/search-console/amp' target='_blank'>https://search.google.com/search-console/amp</a>.</p>
</li>
</ol>
