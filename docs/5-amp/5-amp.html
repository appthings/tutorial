<h2 id="lab-5-accelerated-mobile-pages-amp-and-node-js">Lab 5: Accelerated Mobile Pages (AMP) and Node.js</h2>
<ol>
<li><p><em>AMP</em> is a way to ensure that web pages render fast on mobile devices, for a better user experience (UX). Visit and browse <a href='https://www.ampproject.org/learn/overview/' target='_blank'>https://www.ampproject.org/learn/overview/</a> to learn more about AMP. Other than fast rendering, one advantage of AMP pages is that Google will cache AMP pages for you for free. There are some restrictions as to what a valid AMP page can include (such as no custom JavaScript), but it allows you to use the full power of CSS. Download and unzip topseed-master.zip from <a href='https://github.com/topseed/topseed' target='_blank'>https://github.com/topseed/topseed</a> to your location of choice on your developer machine. We use the &#39;dynamic&#39;, server-side features of Node.js to help with serving AMP pages where appropriate. It is, however, possible to create a completely static site that serves AMP. In this tutorial, we show how both AMP and non-AMP versions can share common resources to limit content duplication.</p>
</li>
<li><p>Install Node.js and NPM. If you have a Mac, follow the instructions at <a href-'http://blog.teamtreehouse.com/install-node-js-npm-mac' target='_blank'>http://blog.teamtreehouse.com/install-node-js-npm-mac</a>. If you have Windows, download and run the installer from <a href='https://nodejs.org/en/download/' target='_blank'>https://nodejs.org/en/download/</a>, accept the default settings, and restart your computer. Open the project you downloaded in step 1 above with VS Code. Select menu View-Integrated Terminal. On the command line that opens, change directories with &#39;cd topseed-srv&#39;. To test Node, type <code>&#39;node -v&#39;</code> and hit <code>Enter</code>. You should see a version number like <code>v8.0.0</code>. To test NPM, type <code>&#39;npm -v&#39;</code> and hit <code>Enter</code>. You should see a version number like <code>4.0.3</code>. Use Google to troubleshoot the install of Node and NPM for your operating system if necessary. </p>
</li>
<li><p>You are almost ready to run the topseed app in Node. First you will use NPM to download the &#39;dependencies&#39; listed in <code>/topseed-srv/package.json</code>. Go back to the Terminal Shell, make sure you are in the <code>/topseed-srv</code> directory, then type <code>&#39;npm install&#39;</code> and hit <code>Enter</code>. This will install the dependencies in a <code>/node_modules</code> directory. It will take a while, but the console will tell you when done. (Repeat this step when you add a dependency yourself.)</p>
</li>
<li><p>Inspect <code>/topseed-srv/index.js</code>. This is the JavaScript file that starts the app, including an <code>&#39;express&#39;</code> HTTP server. Return to the Terminal Shell (still in the <code>/topseed-srv</code> directory) and type <code>&#39;node index&#39;</code> (you can omit the <code>.js</code>) and hit <code>Enter</code> to start the app. You should see output like &#39;App listening on port 8091&#39; and 8092. (To stop it, you would press <code>Ctrl+C</code>).</p>
</li>
<li><p>In a browser, go to <a href='http://localhost:8091' target='_blank'>http://localhost:8091</a> and see /page/one/ come up. Rightclick on the page to &#39;Show HTML source&#39;. You will note that the <code>head</code> tag has AMP-specific content. To compare, review the HTML source or the non-AMP version at <code>localhost:8092</code>.
In production, we would likely map port 8091 to <code>m.mydomain.com</code> and port 8092 to <code>www.mydomain.com</code>. Behind the scenes, we have a Node module at <code>/topseed-srv/util/Decider.js</code>. The function of <code>Decider</code> with regard to AMP is twofold: (a) if a request of <code>/page/one/</code> is on the first port, it will return the HTML from <code>/page/one/indexA.html</code>; if the request is on the second port, it will return the HTML from <code>/page/one/index.html</code>.  (b) it will attempt to return the alternate version if the requested one does not exist, no matter what port the request arrived on. You can change port numbers in <code>/topseed-srv/config/ServerConfig.js</code> (restart with &#39;node index&#39;).</p>
</li>
<li><p>Let us inspect how AMP pages are composed differently, but share some resources. Inspect <code>/page/one/indexA.pug</code>. Our convention is to post-fix AMP-specific resources with a capital <code>&#39;A&#39;</code>. See how <code>/indexA.pug</code> uses <code>_baseShellA.pug</code> and <code>_headerA.pug</code>, but uses the same <code>_footer.pug</code> as non-AMP <code>/index.pug</code>.
Likewise, both <code>/index.pug</code> and <code>/indexA.pug</code> share the use of <code>_hello.html</code>.
<code>indexA.pug</code> also has a required &#39;canonical&#39; link that points to the non-AMP version of the resource. Also note that <code>/indexA.pug</code> does not have the <code>&#39;script&#39;</code> element, since AMP does not permit custom JavaScript. AMP has some custom tags/components to help building AMP pages; see <a href='https://www.ampproject.org/docs/reference/components' target='_blank'>https://www.ampproject.org/docs/reference/components</a>. For example, JavaScript <em>is</em> allowed inside an <code>amp-iframe</code> (example at <a href='https://m.appthings.io' target='_blank'>https://m.appthings.io</a>). </p>
</li>
<li><p>Inspect <code>/_part/_baseShellA.pug</code>. It <em>includes</em> <code>&#39;_topA.pug&#39;</code>, which is a non-JavaScript version of <code>&#39;_top.pug&#39;</code> that uses the <code>&#39;#sidedrawer</code>&#39; anchor combined with CSS to obtain the slide-out functionality without JavaScript. Also inspect <code>/_part/_headerA.pug</code>. It includes <code>&#39;../_sass/mainA.css&#39;</code> inside a <code>&#39;style(amp-custom=&#39;&#39;)&#39;</code> tag. This means that the CSS for AMP is served inline rather than from a separate request. <code>mainA.sass</code> has the same content as <code>main.sass</code>, but having a separate file for <code>mainA</code> allows us to compress or <em>mininize</em> it (we use Prepros on the individual file) for inline use, since AMP files have a total size limitation.</p>
</li>
<li><p>Both AMP and non-AMP versions have the same responsive design features: they adapt to screen size. The AMP version should just be served faster, as optimized and privileged by Google caching. This may be especially important for the home page, where you do not want to let the user wait unnecessarily for the page to render. For custom behavior, you can force the <em>non</em>-AMP version by using the whole path <code>/page/one/index.html</code> in links or in the browser. We could make all <code>&#39;a href&#39;</code> links in the app to go to non-AMP versions by adding <code>/index.html</code> to them. We usually do this to take advantage of the (JavaScript-based) Topseed Turbo feature that provides for a smoother single-page application feel.</p>
</li>
<li><p>In summary, the app supports fast AMP responses but provides for non-AMP fallback versions where necessary. For example, a &#39;Contact Us&#39; page that uses JavaScript to validate submissions would not have an AMP version. <code>Decider.js</code> on the server-side helps to automatically serve the available version.</p>
</li>
<li><p>You can use an AMP validator to ensure your AMP is valid; see <a href='https://validator.ampproject.org' target='_blank'>https://validator.ampproject.org</a>. Your markup has to be valid to be indexed and cached by Google. If your page is online, you can re-validate and submit it at <a href='https://search.google.com/search-console/amp' target='_blank'>https://search.google.com/search-console/amp</a>.</p>
</li>
</ol>
