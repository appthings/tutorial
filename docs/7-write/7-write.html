<h2 id="lab-7-ui-writing-to-an-api-example-firebase-">Lab 7: UI Writing to an API (Example: Firebase)</h2>
<ol>
<li><p>In a browser, return to the <a href='http://localhost:8091/admin/linkblog/' target='_blank'>Linkblog list</a>, and click the &#39;Add Item&#39; button to see <a href='http://localhost:8091/admin/linkblog/detail.html' target='_blank'>/admin/linkblog/detail.html</a>. Note that the Date field is prepopulated with today&#39;s date. In VS Code, inspect /topseed-webroot/admin/linkblog/detail.pug. This file defines the composition of the Linkblog Add Item screen. In the &#39;HTML&#39; part of this file, the data entry form represented by the pug statement &#39;form#form1&#39; (&lt;form id=&quot;form1&quot;&gt;). Note that it has &#39;onsubmit=&#39;return false&#39;, because we do not want the browser default behavior of posting to a form action URL.</p>
</li>
<li><p>Similar to the  list page, in &#39;script.&#39; we load /admin/linkblog/LinkblogBusiness.js, and then call the UIinit function in the page. UIinit triggers the &#39;detail()&#39; function of LinkblogBusiness, which loads today&#39;s date into the form. UIinit also specifies to call the LinkblogBusiness save() function when the form is submitted (when the &#39;Save&#39; button is clicked) instead of the default behavior, and pass any authentication cookie along. Since we are working with similar data as in the list page, and the two pages belong together, we have chosen to augment LinkblogBusiness.js with the detail() and save() functions rather than creating separate LinkblogListBusiness and LinkblogAddBusiness. For a different module we would create a separate XxxBusinness.</p>
</li>
<li><p>Reopen /topseed-webroot/admin/linkblog/LinkblogBusiness.js and locate the &#39;detail: function(&#39;. We use <a href='https://momentjs.com/' target='_blank'>moment.js</a> for date handling and <a href='https://github.com/corinis/jsForm' target='_blank'>jquery.jsForm</a> to populate the form with the date. The necessary libraries are loaded in /_js/admin.js. You see the result of the call to detail() when rendering of the page has completed.</p>
</li>
<li><p>Fill some data in the form and click &#39;Save&#39;. You should see an alert that saving is not enabled: we are not yet configured to use a database that allows saving. In LinkblogBusiness.js, locate the &#39;save: function(&#39;. Once we enable &#39;update&#39; in the urlSpec, processing will continue. We obtain the &#39;formData&#39; with jquery.jsForm(&#39;get&#39;), and pass it to the linkblogDao.update function. Once this has returned successfully (&#39;promise.then(&#39;), we redirects to the list page. BLX/sb has base functionality using turbo for the new page load.</p>
</li>
<li><p>Reopen BDS and look for the &#39;update: function(&#39;. It calls a shared static _post function which uses fetch_ to call the urlSpec update URL. </p>
</li>
<li><p>It is time to connect LinkblogDao/BDS to a live database. Go to the top of LinkblogBusiness.js, comment out the first urlSpec and comment in the urlSpec that goes to localhost:8081, does not use dummy.json and also has an update route, unlike the first urlSpec. We included a small API server implementation in the topseed project at topseed/bsrv that we will run at localhost:8081. The API server in turn will call a Google Firebase service that you will configure in the next step. Why do we not call the Firebase API directly from the browser? We do not want the browser to hold the authentication credentials for the database connection (more about user authentication later).</p>
</li>
<li><p>Log into your Gmail/Google account at <a href="https://mail.google.com">https://mail.google.com</a> (Create on if you don&#39;t have one). Navigate to <a href='https://console.firebase.google.com/' target='_blank'>console.firebase.google.com</a>, click &#39;Add Project&#39;, enter &#39;mydb1&#39; as Project name when prompted and click &#39;Create Project&#39;.
Click the &#39;gear&#39; icon on the left menu (enlarge browser window if necessary to see it) to access Project Settings and click the &#39;Service Accounts&#39; tab. Copy the &#39;databaseURL&#39; value from the Node.js Admin SDK configuration snippet and paste it into the  topseed/bsrv/config/ApiConfig.js DB_URL return value. The line in ApiConfig.js should look something like &#39;get DB_URL() { return &#39;<a href="https://mydb1-7b77e.firebaseio.com">https://mydb1-7b77e.firebaseio.com</a>&#39; }&#39; Still on the Google Project Settings Service Accounts tab, click &#39;Generate New Private Key&#39; and &#39;Generate Key&#39;. From the download prompt, save the file into the /topseed/bsrv/scode/route/ds/ folder. Open BaseFB.js, and replace serviceKey.json with the filename. The line should look something like const &#39;serviceAccount = require(&quot;./mydb1-7b77e-firebase-adminsdk-8swi6-f46e592e60.json&quot;)&#39; Ensure that the filename starts with &#39;./&#39;.</p>
</li>
<li><p>You are ready to start the API server that uses this configuration. In VS Code, open another Terminal Shell (Ctrl+Shift+`), type &#39;cd bsrv [enter]&#39;, do the &#39;npm install [enter] &#39; and then &#39;node index [Enter].
You should see console output &#39;App listening at <a href="http://localhost:8081">http://localhost:8081</a>&#39;
On the VS Code terminal tab, go to the tab for topseed, and start it if not already running.</p>
</li>
<li><p>In a browser, go to the <a href='http://localhost:8091/admin/linkblog/' target='_blank'>Linkblog list</a>. The list should say &#39;No data available in table&#39; (at least when LinkblogBusiness urlSpec points to the newly configured API server that has an &#39;empty&#39; DB. Click the &#39;Add Item&#39;, enter some values and click &#39;Save&#39;. Your item should appear in the list. Back in the Navigate to <a href='https://console.firebase.google.com/' target='_blank'>console.firebase.google.com</a> for the project &#39;mydb1&#39;, In the left menu navigate to &#39;Database&#39;. You should be able to drill down to see the newly created entry in a table named &#39;links11&#39;. Feel free to add more items with &#39;Add Item&#39; at <a href='http://localhost:8091/admin/linkblog/' target='_blank'>Linkblog list</a></p>
</li>
<li><p>Optional: Learn how the API server at /bsrv works. Inspect /bsrv/index.js. The line beginninng with &#39;server.use(&#39;/linkblog&#39;&#39; specifies that any requests to localhost:8081/linkblog are handled
by /scode/route/LinkblogService.js. Inspect this file. Then the function beginning with &#39;router.post(&#39;/&#39;&#39; specifies in the line &#39;const _promise = linkblog.update(row)&#39; that a post request will call the update function in /ds/Linkblog.js. Inspect this file. Linkblog.js specifies the table name as &#39;links11&#39;, but also extends BaseFB, which has the common functionality to use the Firebase connection, query and update the database using the firebase-admin package imported as a dependency in /bsrv/package.json. Since this code runs in the Node.js server and not in the browser, we can use &#39;extends&#39; instead of .extends([. To add a row, BaseFB.js &#39;update(row)&#39; was used. Similarly, a &#39;get&#39; request to localhost:8081/linkblog used BaseFB.js &#39;selectList()&#39; to obtain the list of linkblog items. If you were to use a different database service provider, you would create an alternative implementation of BaseFB. For a complete Create-Read-Update-Delete (CRUD) implementation, we would add single-row query, update and delete capablity.</p>
</li>
</ol>
