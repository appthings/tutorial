## Lab 9: Standard Web Components and their Communication

1. Web component frameworks have a short half-life. The last years has seen a rapid succession of what's commonly considered 'the best', or even just popular: Backbone, Knockout, Ember, Angular, Angular 2, React, Vue, Riot and Polymer. You can find a comparison at <a href='http://jeffcarp.github.io/frontend-hyperpolyglot/' target='_blank'>http://jeffcarp.github.io/frontend-hyperpolyglot/</a> It's a jungle out there. History shows that what you would pick today is likely not what you would pick 18 months from now. That presents the developer or architect with a great challenge of how to ensure maintainability of an application. You don't want to start from scratch and rewrite everything every 18 months!
Our best practice for this is to write webapps that are structured in a 'component-framework-agnostic' way, where you can potentially keep existing components around, but develop new components using a newer component framework. We believe that the approach shown in these labs can achieve this. Part of this is that we avoid navigation mechanisms (routers) that would tie us to a specific component framework but use the browser's native mechanisms instead.

For those that don't have a favorite component yet, there may be light at the end of the tunnel. TBD...

2. Download and unzip topseed-webcomps-master.zip from <a href='https://github.com/topseed/topseed-webcomps' target='_blank'>here</a> to your location of choice on your developer machine. We use the 'dynamic', server-side features of Node.js to help with serving AMP pages where appropriate. It is, however, possible to create a completely static site that serves AMP. In this tutorial, we show how both AMP and non-AMP versions can share common resources to limit content duplication.

2. Install Node.js and NPM. If you have a MAC, follow the instructions <a href-'http://blog.teamtreehouse.com/install-node-js-npm-mac' target='_blank'>here</a>. If you have Windows, download and run the Installer from <a href='https://nodejs.org/en/download/' target='_blank'>here</a>, accept the default settings, and RESTART your computer. Open the project you downloaded in step 2 above with VS Code. Select menu View-Integrated Terminal. On the command line that opens, change directories with 'cd topseed-srv'. To test Node, type 'node -v' and hit Enter. You should see a version number like v8.0.0. To test NPM, type 'npm -v' and hit Enter. You should see a version number like 4.0.3. Use Google to troubleshoot the install for your OS if necessary. 

3. You are almost ready to run the topseed app in Node. First you will use NPM to download the 'dependencies' listed in /topseed-srv/package-json. Go back to the Terminal Shell, make sure you are in the /topseed-srv directory, then type 'npm install' and hit Enter. This will install the dependencies in a '/node_modules' directory. This will take a while, but the console will tell you when done. (Repeat this when you add a dependency yourself).

4. Inspect /topseed-srv/index.js. This is the JavaScript file that starts the app, including an 'express' http server. Return to the Terminal Shell (still in the /topseed-srv directory) and type 'node index' (you can omit the .js) and hit Enter to start the app. You should see output like 'App listening on port 8091 and 8092. (To stop it, you would press Ctrl+C).

5. In a browser, go to <a href='http://localhost:8091' target='_blank'>localhost:8091</a> and see /page/one/ come up. Rightclick on the page to 'Show HTML source'. You will note that the head tag has AMP-specific content. To compare, review the HTML source or the non-AMP version at localhost:8092.
In production, we would likely map port 8091 to m.mydomain.com and port 8092 to www.mydomain.com. Behind the scenes, we have a Node module at /topseed-srv/util/Decider.js. The function of Decider is twofold: a) If a request of /page/one/ is on the first port, it will return the HTML from /page/one/indexA.html; if the request is on the second port, it will return the HTML from /page/one/index.html.  b) It will attempt to return the alternate version if the requested one does not exist, no matter what port the request came on.
You can change port numbers in /topseed-srv/config/ServerConfig.js (restart with 'node index').

6. Let us inspect how AMP pages are composed differently, but share some resources. Inspect '/page/one/indexA.pug'. Our convention is to post-fix AMP-specific resources with a capital A. See how /indexA.pug uses _baseShellA.pug and _headerA.pug, but uses the same _footer.pug as non-AMP /index.pug.
Likewise, both /index.pug and /indexA.pug share the use of _hello.html.
indexA.pug also has a required 'canonical' link that points to the non-AMP version of the resource. Also note that /indexA,pug does not have the 'script' element, since AMP does not permit custom JavaScript. AMP has some custom <a href='https://www.ampproject.org/docs/reference/components' target='_blank'>tags/components</a> to help building AMP pages. For example, JavaScript IS allowed inside an amp-iframe (example  <a href='https://www.rfidthings.com' target='_blank'>here</a>). 

7. Inspect /_part/_baseShellA.pug. It includes _topA.pug, which is a non-JavaScript version of _top.pug that uses the #sidedrawer anchor combined with CSS to obtain the slide-out functionality without JavaScript. Also inspect /_part/_headerA.pug. It *includes* ../_sass/mainA.css inside a style(amp-custom='') tag. This means that the CSS for AMP is served inline rather than from a separate request. mainA.sass has the same content as main.sass, but having a separate file for mainA allows us to compress or 'mininize' it (we use Prepros on the individual file) for inline use, since AMP files have a total size limitation.

8. Both AMP and non-AMP versions have the same responsive design features (they adapt to screen size). The AMP version should just be served faster, as optimized and privileged by Google caching. This may be especially important for the home page, where you do not want to let the user wait unnecessarily for the page to render. For custom behavior, you can force the non-AMP version by using the whole path /page/one/index.html in links or in the browser. We could make all 'a href' links in the app to go to non-AMP versions by adding /index.html to them. We usually do this to take advantage of the (JavaScript-based) Topseed Turbo feature that provides for a smoother Single-Page Application feel.

9. In summary, the app supports fast AMP responses but provides for non-AMP fallback versions where necessary. For example, a 'Contact Us' page that uses JavaScript to validate submissions would not have an AMP version. Decider.js on the server-side helps to automatically serve the available version.

10. You can use an <a href='https://validator.ampproject.org' target='_blank'>AMP validator </a> to ensure your AMP is valid. It has to be valid to be indexed and cached by Google. If your page is online, you can revalidate and submit it <a href='https://search.google.com/search-console/amp' target='_blank'>here</a>.
